#!/bin/sh
# common.env
# Common environment variables for the kernel build setup.
# Source this file inside run.sh or manually.

# ──────────────────────────────────────────────────────────────────────────────
# 0. Global Paths & Configuration
# ──────────────────────────────────────────────────────────────────────────────
# Detect where this script is located to anchor relative paths
export SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Image Configuration
export IMAGE_FILE="${SCRIPT_DIR}/img.sparseimage"
export VOLUME_NAME="kernel-dev"
export MOUNT_POINT="/Volumes/${VOLUME_NAME}"

# Kernel Source Path (inside the mount)
export KERNEL_DIR="${MOUNT_POINT}/linux"
export BASE_BRANCH="master"

# QEMU and ROOTFS Configuration
export DEBIAN_MIRROR="http://deb.debian.org/debian"
export DEBOOTSTRAP_PATH="${SCRIPT_DIR}/tools/debootstrap"
export ROOTFS_DIR="${MOUNT_POINT}/rootfs"   # Temporary directory for building the root filesystem
export DISK_IMAGE="${MOUNT_POINT}/disk.img" # Final ext4 disk image used as root device in QEMU
export DISK_SIZE="5G"                       # Virtual size of the disk image (adjustable)

# ANSI Colors for cleaner output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

# ──────────────────────────────────────────────────────────────────────────────
# 1. Homebrew Check
# ──────────────────────────────────────────────────────────────────────────────
if ! command -v brew >/dev/null 2>&1; then
	echo "Error: Homebrew not found → https://brew.sh"
	exit 1
fi

# ──────────────────────────────────────────────────────────────────────────────
# 2. PATH Components (split for clarity)
# ──────────────────────────────────────────────────────────────────────────────

# GNU sed (prefers BSD-sed on macOS unless replaced)
GNUSED_BIN="$(brew --prefix gnu-sed)/libexec/gnubin"

# LLVM toolchain (clang / ld.lld)
LLVM_BIN="$(brew --prefix llvm)/bin"

# Standalone LLD linker
LLD_BIN="$(brew --prefix lld)/bin"

# Get e2fsprogs binary path for ext4 tools
E2FSPROGS_BIN="$(brew --prefix e2fsprogs)/sbin"

# Export package PATH one by one
PATH="${GNUSED_BIN}:${PATH}"
PATH="${LLVM_BIN}:${PATH}"
PATH="${LLD_BIN}:${PATH}"
PATH="${E2FSPROGS_BIN}:${PATH}"
export PATH

# ──────────────────────────────────────────────────────────────────────────────
# 3. Host CFLAGS (headers required for macOS kernel builds)
# ──────────────────────────────────────────────────────────────────────────────

# Path to your custom macOS-compatible headers
MACOS_HEADERS="${HOME}/Documents/kernel-dev/linux/libraries"

# libelf (needed for kernel modules & BPF)
LIBELF_INCLUDE="$(brew --prefix libelf)/include"

# Enable necessary flags for macOS kernel compilation
NATIVE_FLAGS="-D_UUID_T -D__GETHOSTUUID_H -D_DARWIN_C_SOURCE -D_FILE_OFFSET_BITS=64"

# Export combined Host CFLAGS
export HOSTCFLAGS="-I${MACOS_HEADERS} -I${LIBELF_INCLUDE} ${NATIVE_FLAGS}"

# ──────────────────────────────────────────────────────────────────────────────
# 4. Optional Host Linker Flags
# ──────────────────────────────────────────────────────────────────────────────

# Uncomment only if needed for libelf linking issues
# LIBELF_LIBDIR="$(brew --prefix libelf)/lib"
# export HOSTLDFLAGS="-L${LIBELF_LIBDIR}"

# ──────────────────────────────────────────────────────────────────────────────
# 5. Load Scripts
# ──────────────────────────────────────────────────────────────────────────────
source "${SCRIPT_DIR}/scripts/doctor.sh"
source "${SCRIPT_DIR}/scripts/image.sh"
source "${SCRIPT_DIR}/scripts/repo.sh"
source "${SCRIPT_DIR}/scripts/branch.sh"
source "${SCRIPT_DIR}/scripts/build.sh"
source "${SCRIPT_DIR}/scripts/patch.sh"
source "${SCRIPT_DIR}/scripts/rootfs.sh"
source "${SCRIPT_DIR}/scripts/qemu.sh"
