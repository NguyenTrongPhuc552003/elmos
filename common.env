#!/bin/sh
# common.env
# Common environment variables for the kernel build setup.
# Source this file inside run.sh or manually.

# ──────────────────────────────────────────────────────────────────────────────
# 1. Homebrew Check
# ──────────────────────────────────────────────────────────────────────────────
if ! command -v brew >/dev/null 2>&1; then
	echo "Error: Homebrew not found → https://brew.sh"
	exit 1
fi

# ──────────────────────────────────────────────────────────────────────────────
# 2. PATH Components (split for clarity)
# ──────────────────────────────────────────────────────────────────────────────

# GNU sed (prefers BSD-sed on macOS unless replaced)
GNUSED_BIN="$(brew --prefix gnu-sed)/libexec/gnubin"

# LLVM toolchain (clang / ld.lld)
LLVM_BIN="$(brew --prefix llvm)/bin"

# Standalone LLD linker
LLD_BIN="$(brew --prefix lld)/bin"

# Export combined PATH
export PATH="${GNUSED_BIN}:${LLVM_BIN}:${LLD_BIN}:${PATH}"

# ──────────────────────────────────────────────────────────────────────────────
# 3. Host CFLAGS (headers required for macOS kernel builds)
# ──────────────────────────────────────────────────────────────────────────────

# Path to your custom macOS-compatible headers
MACOS_HEADERS="${HOME}/Documents/kernel-dev/linux/headers"

# libelf (needed for kernel modules & BPF)
LIBELF_INCLUDE="$(brew --prefix libelf)/include"

# Enable necessary flags for macOS kernel compilation
NATIVE_FLAGS="-D_UUID_T -D__GETHOSTUUID_H -D_DARWIN_C_SOURCE -D_FILE_OFFSET_BITS=64"

# Export combined Host CFLAGS
export HOSTCFLAGS="-I${MACOS_HEADERS} -I${LIBELF_INCLUDE} ${NATIVE_FLAGS}"

# ──────────────────────────────────────────────────────────────────────────────
# 4. Optional Host Linker Flags
# ──────────────────────────────────────────────────────────────────────────────

# Uncomment only if needed for libelf linking issues
# LIBELF_LIBDIR="$(brew --prefix libelf)/lib"
# export HOSTLDFLAGS="-L${LIBELF_LIBDIR}"
