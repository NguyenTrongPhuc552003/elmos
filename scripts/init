#!/bin/sh

MARKER="/.rootfs-setup-complete"

echo "Booting Debian root filesystem..."

if [ ! -f "$MARKER" ]; then
    echo "First boot detected – running debootstrap second stage..."
    /debootstrap/debootstrap --second-stage
    if [ $? -eq 0 ]; then
        touch "$MARKER"
        echo "Second stage completed successfully."
    else
        echo "Second stage failed – dropping to emergency shell."
        if [ -f /debootstrap/debootstrap.log ]; then
            echo "--- LOG START ---"
            cat /debootstrap/debootstrap.log
            echo "--- LOG END ---"
        fi
        exec /bin/sh
    fi
else
    echo "Root filesystem already set up."
fi

# Mount essential virtual filesystems
mount -t proc  proc  /proc
mount -t sysfs sys   /sys
mount -t devtmpfs dev /dev 2>/dev/null || mount -t tmpfs dev /dev
[ -d /dev/pts ] || mkdir /dev/pts
mount -t devpts devpts /dev/pts

# Network configuration (static for QEMU user mode)
ip link set lo up
ip link set eth0 up
ip addr add 10.0.2.15/24 dev eth0
ip route add default via 10.0.2.2

# DNS setup
echo "nameserver 8.8.8.8" > /etc/resolv.conf

# Mount the 9p share from macOS
mkdir -p /mnt/modules
mount -t 9p -o trans=virtio,version=9p2000.L modules_mount /mnt/modules

# Execute module orchestration script if present
if [ -f /mnt/modules/guesync.sh ]; then
	echo "Running guest module synchronization script..."
	/mnt/modules/guesync.sh
else
	echo "No module synchronization script found."
fi

echo "System ready."

# Drop to interactive shell
exec /bin/sh
